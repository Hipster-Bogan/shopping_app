{% extends "base.html" %}
{% block title %}{{ shopping_list.name }}{% endblock %}

{% block head %}
<style>
  .list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    margin-bottom: 8px;
  }
</style>
{% endblock %}

{% block content %}
<h5 class="text-center mb-3">{{ shopping_list.name }}</h5>

<form id="add-form" class="d-flex mb-3">
  <input id="item-input" class="form-control me-2" placeholder="Add item..." required>
  <button class="btn btn-success">+</button>
</form>

<div id="items">
  {% for item in shopping_list.items %}
  <div class="list-item" data-id="{{ item.id }}">
    <span>{{ item.item }}</span>
    <button class="btn btn-sm btn-outline-danger remove-btn" data-id="{{ item.id }}">✕</button>
  </div>
  {% endfor %}
</div>

<div class="mt-4 text-center">
  <small class="text-muted">Share token: <b>{{ shopping_list.share_token }}</b></small>
</div>
{% endblock %}

{% block scripts %}
<script>
  const socket = io();
  const listToken = {{ shopping_list.token | tojson }};
  const displayName = {{ session.get('email', 'Guest') | tojson }};

  socket.on('connect', () => {
    socket.emit('join', { token: listToken, name: displayName });
  });

  const form = document.getElementById('add-form');
  const input = document.getElementById('item-input');
  const itemsDiv = document.getElementById('items');

  form.addEventListener('submit', e => {
    e.preventDefault();
    const value = input.value.trim();
    if (!value) {
      return;
    }
    socket.emit('add_item', { token: listToken, item: value, quantity: 1 });
    input.value = '';
  });

  itemsDiv.addEventListener('click', e => {
    if (e.target.classList.contains('remove-btn')) {
      const id = e.target.getAttribute('data-id');
      socket.emit('delete_item', { token: listToken, id: Number(id) });
    }
  });

  socket.on('item_added', item => {
    const div = document.createElement('div');
    div.classList.add('list-item');
    div.setAttribute('data-id', item.id);

    const span = document.createElement('span');
    span.textContent = item.item;
    div.appendChild(span);

    const button = document.createElement('button');
    button.className = 'btn btn-sm btn-outline-danger remove-btn';
    button.setAttribute('data-id', item.id);
    button.textContent = '✕';
    div.appendChild(button);

    itemsDiv.appendChild(div);
  });

  socket.on('item_deleted', ({ id }) => {
    const itemDiv = itemsDiv.querySelector(`.list-item[data-id="${id}"]`);
    if (itemDiv) {
      itemDiv.remove();
    }
  });
</script>
{% endblock %}
